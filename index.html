<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>NOX — Narrative Options Exchange</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin:0; background:#0b0b0c; color:#f5f6f8; }
    header { padding: 24px; border-bottom:1px solid #222; position: sticky; top:0; background: rgba(11,11,12,0.9); backdrop-filter: blur(6px); }
    h1 { margin: 0 0 8px; font-size: 22px; }
    .sub { color:#b9bcc2; font-size: 14px; }
    main { padding: 20px; max-width: 1100px; margin: 0 auto; }
    .actions { display:flex; gap:10px; margin:12px 0 18px; flex-wrap:wrap; }
    button { background:#111317; color:#f5f6f8; border:1px solid #2a2d34; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:600; }
    button:hover { border-color:#3a3f48; }
    .grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap:12px; }
    .card { border:1px solid #1f232b; background:#0f1115; padding:14px; border-radius:14px; }
    .title { font-weight:700; font-size:16px; margin-bottom:4px; }
    .thesis { font-size:13px; color:#b9bcc2; min-height: 36px; }
    .row { display:flex; align-items:center; justify-content:space-between; margin-top:10px; }
    .price { font-weight:800; font-size: 22px; }
    .leader { font-size: 12px; color:#b9bcc2; }
    .notice { background:#0b0d11; border:1px dashed #2a2d34; padding:10px; border-radius:10px; margin-top: 8px; font-size: 12px; color:#b9bcc2; }
    .spark { height: 30px; width: 100%; }
    footer { padding: 30px; text-align:center; color:#8a8f98; }
  </style>
</head>
<body>
  <header>
    <h1>NOX — Narrative Options Exchange</h1>
    <div class="sub">Long/short emerging Edge AI narratives with <b>points</b>, not cash. When conviction is high, we <b>build</b> a live MVP.</div>
    <div class="actions">
      <button id="loginBtn">Sign Handle / +100 pts</button>
    </div>
  </header>

  <main>
    <section id="board" class="grid"></section>
  </main>

  <footer>Points-only. Research & entertainment. No securities.</footer>

  <script>
  // ===== inline NOX app (single-file) =====
  const ENDPOINTS = {
    BOARD: "https://script.google.com/macros/s/AKfycbwY4xV58FIJEQ359m3DSAyCoN1_YYxvRxbeG6kVojGr94XIadfinLs5PLC50qpvPe3_/exec?route=board",
    TRADE: "https://script.google.com/macros/s/AKfycbwY4xV58FIJEQ359m3DSAyCoN1_YYxvRxbeG6kVojGr94XIadfinLs5PLC50qpvPe3_/exec?route=trade",
    LEADERBOARD: "https://script.google.com/macros/s/AKfycbwY4xV58FIJEQ359m3DSAyCoN1_YYxvRxbeG6kVojGr94XIadfinLs5PLC50qpvPe3_/exec?route=leaderboard"
  };

  // Map narrative IDs -> demo URLs
  const DEMOS = { e2: "https://alichodri.github.io/nox-exercise-e2/" };

  // Fallback data so cards render even if API is unreachable
  const SAMPLE_BOARD = {
    narratives: [
      { id: "e1", title: "On-device HR copilots", thesis: "Private HR assistants on laptops/phones (compliance, low latency).", price: 58, volume_24h: 90, last_move: +2, exercise: 52 },
      { id: "e2", title: "Edge RAG for Field Service", thesis: "Local doc Q&A for field techs (offline manuals + photos).", price: 63, volume_24h: 140, last_move: +5, exercise: 70 },
      { id: "e3", title: "Retail Loss Prevention Vision", thesis: "Tiny models on cameras for shrink detection, no cloud feed.", price: 61, volume_24h: 120, last_move: +4, exercise: 66 }
    ]
  };

  async function fetchBoard() {
    try {
      const r = await fetch(ENDPOINTS.BOARD, { cache: "no-store" });
      if (!r.ok) throw new Error("HTTP " + r.status);
      const j = await r.json();
      if (!j || !Array.isArray(j.narratives) || j.narratives.length === 0) return SAMPLE_BOARD;
      return j;
    } catch (e) {
      console.warn("Fetch failed, using SAMPLE_BOARD fallback:", e);
      return SAMPLE_BOARD;
    }
  }

  function renderSparkline(canvas, points) {
    const ctx = canvas.getContext("2d");
    const w = canvas.width = canvas.clientWidth;
    const h = canvas.height = canvas.clientHeight;
    const max = Math.max(...points), min = Math.min(...points);
    const norm = v => (h - 6) - ((v - min) / (max - min || 1)) * (h - 12);
    ctx.lineWidth = 2; ctx.beginPath(); ctx.moveTo(0, norm(points[0]));
    const step = w / (points.length - 1);
    for (let i = 1; i < points.length; i++) ctx.lineTo(i * step, norm(points[i]));
    ctx.strokeStyle = "#9fb7ff"; ctx.stroke();
  }

  function renderBoard(data) {
    const grid = document.getElementById("board");
    grid.innerHTML = "";

    data.narratives.forEach(n => {
      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <div class="title">${n.title}</div>
        <div class="thesis">${n.thesis}</div>
        <div class="row">
          <div>
            <div class="price">${n.price}</div>
            <div class="leader">24h ${n.last_move > 0 ? "+" : ""}${n.last_move} • Vol ${n.volume_24h}</div>
          </div>
          <div style="display:flex; gap:8px; align-items:center;">
            <button data-side="long" data-id="${n.id}">Long</button>
            <button data-side="short" data-id="${n.id}">Short</button>
            ${ DEMOS[n.id]
              ? `<a href="${DEMOS[n.id]}" target="_blank" rel="noopener" style="text-decoration:none"><button>Demo</button></a>`
              : `` }
          </div>
        </div>
        <div class="notice">Exercise Track: ${n.exercise || 0}%</div>
        <canvas class="spark"></canvas>
      `;
      grid.appendChild(card);

      const spark = card.querySelector(".spark");
      const pts = Array.from({ length: 24 }, () => n.price + Math.round((Math.random() - 0.5) * 8));
      renderSparkline(spark, pts);
    });

    // Click handlers for trades
    grid.querySelectorAll("button[data-side]").forEach(btn => {
      btn.addEventListener("click", async () => {
        const side = btn.dataset.side, id = btn.dataset.id;
        let handle = localStorage.getItem("nox_handle");
        if (!handle) {
          handle = prompt("Pick a handle (letters/numbers)");
          if (!handle) return;
          localStorage.setItem("nox_handle", handle);
        }
        const payload = { user: handle, narrative_id: id, side, points: 10 };
        try {
          const r = await fetch(ENDPOINTS.TRADE, {
            method: "POST",
            headers: { "Content-Type": "text/plain;charset=utf-8" }, // simple request (no preflight)
            body: JSON.stringify(payload)
          });
          const msg = await r.text();
          alert(msg);
          location.reload();
        } catch (e) {
          console.error(e);
          alert("Trade failed. Check console.");
        }
      });
    });
  }

  // Wire login + render after DOM ready
  window.addEventListener("DOMContentLoaded", async () => {
    const loginBtn = document.getElementById("loginBtn");
    if (loginBtn) {
      loginBtn.addEventListener("click", () => {
        const h = prompt("Pick a handle (letters/numbers).");
        if (h) { localStorage.setItem("nox_handle", h); alert(`Welcome ${h}! You have 100 points today.`); }
      });
    }
    const board = await fetchBoard();
    renderBoard(board);
  });
  <script src="app.js?v=1" defer></script>

</body>
</html>
